<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ki-Awet Smart Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #7F1D8E;
            --primary-dark: #581c63;
            --bg-color: #f8f9fa;
            --text-dark: #333;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: #000;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: absolute;
            top: 0;
            width: 100%;
            z-index: 10;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .back-btn {
            font-size: 1.2rem;
            color: var(--primary);
            cursor: pointer;
        }

        .view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        #cameraView {
            background: #000;
            z-index: 1;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            aspect-ratio: 3/4;
            border-radius: 20px;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .scan-corners {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
        }

        .scan-corners::before,
        .scan-corners::after,
        .scan-corners span::before,
        .scan-corners span::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: var(--primary);
            border-style: solid;
            border-width: 4px;
            border-radius: 4px;
        }

        .scan-corners::before {
            top: -2px;
            left: -2px;
            border-right: 0;
            border-bottom: 0;
        }

        .scan-corners::after {
            top: -2px;
            right: -2px;
            border-left: 0;
            border-bottom: 0;
        }

        .scan-corners span::before {
            bottom: -2px;
            left: -2px;
            border-right: 0;
            border-top: 0;
        }

        .scan-corners span::after {
            bottom: -2px;
            right: -2px;
            border-left: 0;
            border-top: 0;
        }

        .controls {
            position: absolute;
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
        }

        .btn-capture {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 5px solid var(--primary);
            cursor: pointer;
            position: relative;
        }

        .btn-capture::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(127, 29, 142, 0.4);
            cursor: pointer;
            width: 80%;
        }

        #resultView {
            background: #f2f4f7;
            z-index: 2;
            transform: translateX(100%);
            overflow-y: auto;
            padding-top: 80px;
            padding-bottom: 40px;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            margin: 20px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            background: var(--primary);
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            margin: 0 auto 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .status-fresh {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-rotten {
            background: #fee2e2;
            color: #991b1b;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            text-align: left;
        }

        .info-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            flex: 1;
            margin: 0 5px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #888;
        }

        .info-value {
            font-weight: bold;
            font-size: 0.9rem;
            color: #333;
        }

        .color-preview {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .loading-indicator {
            position: absolute;
            bottom: 100px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        #canvas {
            display: none;
        }
    </style>
</head>

<body>

    <div id="cameraView" class="view">
        <div class="header">
            <i class="fas fa-chevron-left back-btn"></i>
            <h2>Ki-Awet Scanner</h2>
            <div style="width: 20px;"></div>
        </div>

        <video id="video" autoplay playsinline></video>

        <div class="scan-overlay">
            <div class="scan-corners"><span></span></div>
        </div>

        <div class="controls">
            <button id="captureBtn" class="btn-capture"></button>
            <p style="color: white; font-size: 0.9rem; margin-top: 10px;">Ambil Gambar</p>
        </div>

        <div class="loading-indicator" id="loadingMsg">
            <i class="fas fa-circle-notch fa-spin"></i> Loading AI Model...
        </div>
    </div>

    <div id="resultView" class="view">
        <div class="header">
            <i class="fas fa-chevron-left back-btn" onclick="resetApp()"></i>
            <h2>Hasil Analisa</h2>
            <div style="width: 20px;"></div>
        </div>

        <div class="result-card" style="padding: 10px;">
            <img id="capturedImage" style="width: 100%; border-radius: 15px;" src="" />
        </div>

        <div class="result-card">
            <div class="score-circle" id="scoreDisplay">?</div>
            <h2 id="statusTitle">Menganalisa...</h2>
            <div id="statusBadge" class="status-badge status-fresh">...</div>

            <div class="color-preview" id="colorPreviewBox"></div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Dominant Color Detected</p>

            <div class="info-row">
                <div class="info-box">
                    <div class="info-label"><i class="far fa-clock"></i> Waktu Scan</div>
                    <div class="info-value" id="timeValue">10:00 WIB</div>
                </div>
                <div class="info-box">
                    <div class="info-label"><i class="fas fa-magic"></i> Akurasi AI</div>
                    <div class="info-value" id="confidenceValue">--%</div>
                </div>
            </div>

            <div class="info-row">
                <div class="info-box">
                    <div class="info-label"><i class="fas fa-drumstick-bite"></i> Produk</div>
                    <div class="info-value">Daging Sapi</div>
                </div>
                <div class="info-box">
                    <div class="info-label"><i class="fas fa-temperature-low"></i> Suhu</div>
                    <div class="info-value">26° C</div>
                </div>
            </div>
        </div>

        <div class="result-card" style="text-align: left;">
            <h3><i class="fas fa-lightbulb" style="color: var(--warning);"></i> Prediksi Keawetan</h3>
            <div style="margin-top: 15px; display: flex; align-items: center;">
                <i class="fas fa-temperature-high" style="margin-right: 10px; color: #e74c3c;"></i>
                <div>
                    <div class="info-label">Suhu Ruang (26°)</div>
                    <div class="info-value" id="shelfLifeRoom">18 - 24 Jam</div>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center;">
                <i class="fas fa-snowflake" style="margin-right: 10px; color: #3498db;"></i>
                <div>
                    <div class="info-label">Kulkas (4°)</div>
                    <div class="info-value" id="shelfLifeFridge">2 - 3 Hari</div>
                </div>
            </div>
        </div>

        <div class="controls" style="position: relative; margin-bottom: 20px;">
            <button class="btn-primary" onclick="resetApp()">Scan Lagi</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let model = null;
        let stream = null;
        let modelReady = false;

        const CLASSES = {
            0: { label: "Sangat Segar", score: 5, css: "status-fresh", desc: "Flavylium (pH 1-3)" },
            1: { label: "Segar", score: 4, css: "status-fresh", desc: "Carbinol (pH 4-5)" },
            2: { label: "Peringatan", score: 3, css: "status-warning", desc: "Quinonoidal (pH 6-7)" },
            3: { label: "Busuk", score: 2, css: "status-rotten", desc: "Anionic Quinonoidal" },
            4: { label: "Sangat Busuk", score: 1, css: "status-rotten", desc: "Chalcone" }
        };

        async function init() {
            startCamera();
            await buildAndTrainModel();
            updateTime();
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Camera access denied or not available.");
            }
        }

        async function buildAndTrainModel() {
            document.getElementById('loadingMsg').style.display = 'block';

            model = tf.sequential();
            model.add(tf.layers.dense({ inputShape: [3], units: 64, activation: 'relu' }));
            model.add(tf.layers.dropout({ rate: 0.2 }));
            model.add(tf.layers.dense({ units: 32, activation: 'relu' }));
            model.add(tf.layers.dense({ units: 16, activation: 'relu' }));
            model.add(tf.layers.dense({ units: 5, activation: 'softmax' }));

            model.compile({
                optimizer: tf.train.adam(0.01),
                loss: 'sparseCategoricalCrossentropy',
                metrics: ['accuracy']
            });

            const X_train = tf.tensor2d([
                [50.0, 60.0, 40.0],
                [60.0, 5.0, 5.0],
                [40.0, 50.0, -20.0],
                [30.0, 10.0, -50.0],
                [70.0, 10.0, 60.0],
            ], [5, 3], 'float32');

            const y_train = tf.tensor1d([0, 1, 2, 3, 4]);

            await model.fit(X_train, y_train, {
                epochs: 100,
                verbose: 0
            });

            X_train.dispose();
            y_train.dispose();

            modelReady = true;
            document.getElementById('loadingMsg').innerHTML = '<i class="fas fa-check-circle"></i> Model Ready';
            setTimeout(() => {
                document.getElementById('loadingMsg').style.display = 'none';
            }, 1500);

            console.log('✓ Ki-Awet Model Trained Successfully');
        }

        function updateTime() {
            const now = new Date();
            const options = { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' };
            document.getElementById('timeValue').innerText = now.toLocaleDateString('id-ID', options) + " WIB";
        }

        document.getElementById('captureBtn').addEventListener('click', async () => {
            if (!modelReady) {
                alert('Model masih loading, tunggu sebentar...');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataURL = canvas.toDataURL('image/png');
            document.getElementById('capturedImage').src = dataURL;

            const rgb = getAverageRGB(ctx, canvas.width, canvas.height);
            await runInference(rgb);

            document.getElementById('cameraView').style.transform = "translateX(-100%)";
            document.getElementById('resultView').style.transform = "translateX(0)";
        });

        function getAverageRGB(context, width, height) {
            const blockSize = 5;
            const centerX = width / 2;
            const centerY = height / 2;
            const regionSize = Math.min(width, height) * 0.4;

            const startX = Math.floor(centerX - regionSize / 2);
            const startY = Math.floor(centerY - regionSize / 2);

            try {
                const imgData = context.getImageData(startX, startY, regionSize, regionSize);
                let r = 0, g = 0, b = 0, count = 0;

                for (let i = 0; i < imgData.data.length; i += 4 * blockSize) {
                    r += imgData.data[i];
                    g += imgData.data[i + 1];
                    b += imgData.data[i + 2];
                    count++;
                }

                return [Math.floor(r / count), Math.floor(g / count), Math.floor(b / count)];
            } catch (e) {
                return [128, 128, 128];
            }
        }

        async function runInference(rgb) {
            const colorBox = document.getElementById('colorPreviewBox');
            colorBox.style.backgroundColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;

            const lab = rgb2lab(rgb);
            console.log("Input Lab:", lab);

            const inputTensor = tf.tensor2d([lab], [1, 3], 'float32');
            const prediction = model.predict(inputTensor);
            const probs = await prediction.data();

            const resultIndex = probs.indexOf(Math.max(...probs));
            const confidence = (Math.max(...probs) * 100).toFixed(1);

            inputTensor.dispose();
            prediction.dispose();

            const res = CLASSES[resultIndex];

            document.getElementById('scoreDisplay').innerText = res.score;
            document.getElementById('statusTitle').innerText = res.desc;

            const badge = document.getElementById('statusBadge');
            badge.className = "status-badge " + res.css;
            badge.innerText = res.label;

            document.getElementById('confidenceValue').innerText = confidence + "%";

            if (res.score >= 4) {
                document.getElementById('shelfLifeRoom').innerText = "18 - 24 Jam";
                document.getElementById('shelfLifeFridge').innerText = "2 - 3 Hari";
            } else if (res.score === 3) {
                document.getElementById('shelfLifeRoom').innerText = "Segera Masak";
                document.getElementById('shelfLifeFridge').innerText = "1 Hari";
            } else {
                document.getElementById('shelfLifeRoom').innerText = "Tidak Layak";
                document.getElementById('shelfLifeFridge').innerText = "Buang";
            }
        }

        function rgb2lab(rgb) {
            let r = rgb[0] / 255, g = rgb[1] / 255, b = rgb[2] / 255;
            r = (r > 0.04045) ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = (g > 0.04045) ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = (b > 0.04045) ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

            let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) * 100;
            let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) * 100;
            let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) * 100;

            x = x / 95.047; y = y / 100.000; z = z / 108.883;
            x = (x > 0.008856) ? Math.pow(x, 1 / 3) : (7.787 * x) + (16 / 116);
            y = (y > 0.008856) ? Math.pow(y, 1 / 3) : (7.787 * y) + (16 / 116);
            z = (z > 0.008856) ? Math.pow(z, 1 / 3) : (7.787 * z) + (16 / 116);

            return [(116 * y) - 16, 500 * (x - y), 200 * (y - z)];
        }

        function resetApp() {
            document.getElementById('cameraView').style.transform = "translateX(0)";
            document.getElementById('resultView').style.transform = "translateX(100%)";
            updateTime();
        }

        init();
    </script>
</body>

</html>
